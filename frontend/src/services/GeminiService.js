/**
 * Gemini API 서비스
 * 게임 캐릭터의 대사를 동적으로 생성
 */

const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY || '';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

/**
 * 게임 컨텍스트 정보
 */
const GAME_CONTEXT = `
게임 정보:
- 제목: 사자의 역습
- 장르: 턴제 전투 + 사자성어 학습 게임

핵심 스토리:
사자는 본래 압도적 힘과 고귀한 덕목을 갖춘 존재로서 12지신의 정점에 있었다.
그러나 그의 권위를 의심하고 시기하던 호랑이가 기습을 감행해 사자의 지위를 탈취했다.
호랑이는 이 과정에서 사자가 지녔던 '자력(字力, 한자에서 유래한 신비한 마력)'까지 완전히 흡수했고,
사자는 모든 힘과 지식을 잃은 채 추방되었다.
이제 사자는 잃어버린 자력과 그 비밀을 되찾기 위해 험난한 여정을 다시 시작한다.

12지신 보스 순서 (사자가 자력을 되찾기 위해 도전하는 순서):
1-4단계 (초급): 토끼(온순), 양(따뜻), 원숭이(영리), 쥐(민첩)
5-8단계 (중급): 돼지(강건), 개(충직), 소(우직), 뱀(신비)
9-12단계 (고급): 말(질주), 봉황(불사조), 용(천상), 호랑이(최종 보스, 배신자)

각 12지신의 성격과 말투 (캐릭터성):
- 토끼 🐰:
  * 성격: 겉으로는 온순하고 평화로워 보이지만, 교활하고 계산적. 빠른 판단력과 회피 능력 자랑
  * 말투: 부드럽지만 비꼬는 투, 상대를 가볍게 보는 태도
  * 울음소리: "끽끽", "끼익"
  * 관련 사자성어 (첫 만남에만 사용): 교토삼굴(狡兎三窟), 토사구팽(兎死狗烹), 동토서오(東兎西烏)

- 양 🐑:
  * 성격: 온화하고 자비로워 보이지만 내면에 단단한 의지. 속을 알 수 없는 신비로움
  * 말투: 따뜻하지만 위압적, 자애로운 듯 경고하는 투
  * 울음소리: "메에~", "메헤헤"
  * 관련 사자성어 (첫 만남에만 사용): 양두구육(羊頭狗肉), 다기양선(多岐羊腺), 양질호피(羊質虎皮)

- 원숭이 🐵:
  * 성격: 영리하고 장난기 많지만 간사함. 트릭과 꾀를 부리는 것을 즐김
  * 말투: 재빠르고 비아냥거리는 투, 말장난을 즐김
  * 울음소리: "끼끼", "끼익끼익", "키킷"
  * 관련 사자성어 (첫 만남에만 사용): 조삼모사(朝三暮四), 목불견심(目不見心)

- 쥐 🐭:
  * 성격: 민첩하고 기민함. 작지만 날카롭고 치밀한 전략가
  * 말투: 빠르고 날카로운 투, 핵심을 찌르는 말
  * 울음소리: "찍찍", "찌익"
  * 관련 사자성어 (첫 만남에만 사용): 서서불락(鼠鼠不落), 명목서치(明目鼠齒)

- 돼지 🐷:
  * 성격: 우직하고 강건함. 느려 보이지만 강력한 힘과 끈기 소유
  * 말투: 묵직하고 느긋한 투, 힘을 과시
  * 울음소리: "꿀꿀", "꾸룩", "끄으응"
  * 관련 사자성어 (첫 만남에만 사용): 돈골상여(豚骨相與), 시호의식(豕虎疑食)

- 개 🐶:
  * 성격: 충성스럽고 정의로움. 규율과 의리를 중시하는 전사
  * 말투: 단호하고 정직한 투, 명령하는 듯한 말투
  * 울음소리: "으르렁", "왈왈", "컹컹"
  * 관련 사자성어 (첫 만남에만 사용): 견마지로(犬馬之勞), 계명구도(鷄鳴狗盜), 견토지공(犬兎之功)

- 소 🐮:
  * 성격: 우직하고 인내심 강함. 느리지만 확실하게, 한 번 시작하면 끝까지
  * 말투: 느리고 무게감 있는 투, 짧고 강렬한 말
  * 울음소리: "음메", "으메에", "으음~"
  * 관련 사자성어 (첫 만남에만 사용): 우보천리(牛步千里), 우이독경(牛耳讀經), 마우상불(馬牛相不)

- 뱀 🐍:
  * 성격: 신비롭고 음험함. 냉정하고 계산적이며 독을 품은 듯한 위협
  * 말투: 낮고 속삭이는 투, 길게 끄는 말투
  * 울음소리: "쉬익~", "스으읏", "치이익"
  * 관련 사자성어 (첫 만남에만 사용): 사족(蛇足), 와신상담(臥薪嘗膽), 용두사미(龍頭蛇尾)

- 말 🐴:
  * 성격: 자유분방하고 역동적. 질주와 속도를 중시하는 열정적인 전사
  * 말투: 시원시원하고 거침없는 투, 활기찬 말투
  * 울음소리: "히힝", "히이잉", "푸르릉"
  * 관련 사자성어 (첫 만남에만 사용): 천리마(千里馬), 새옹지마(塞翁之馬), 주마간산(走馬看山)

- 봉황(닭) 🐔:
  * 성격: 고귀하고 오만함. 불사조의 권능을 가진 자로서 거만하고 화려함
  * 말투: 도도하고 선언적인 투, 자신의 위엄을 과시
  * 울음소리: "꼬끼오", "꼬꼬댁", "꾸우욱"
  * 관련 사자성어 (첫 만남에만 사용): 금계독립(金鷄獨立), 계명구도(鷄鳴狗盜), 문전성시(門前成市)

- 용 🐲:
  * 성격: 천상의 존재로서 절대적 위엄. 초월적이고 신성하며 압도적
  * 말투: 장엄하고 웅장한 투, 천둥소리 같은 말투
  * 울음소리: "크아아앙", "끄으오오", "쿠오오옹"
  * 관련 사자성어 (첫 만남에만 사용): 용호상박(龍虎相搏), 화룡점정(畫龍點睛), 비룡승천(飛龍昇天)

- 호랑이 🐯:
  * 성격: 백수의 왕이자 배신자. 오만하고 잔인하지만 사자를 두려워함
  * 말투: 위압적이고 공격적인 투, 으르렁거리는 듯한 말투
  * 울음소리: "어흥", "으르렁", "크르렁"
  * 관련 사자성어 (첫 만남에만 사용): 호가호위(狐假虎威), 포호풍하(暴虎馮河), 용호상박(龍虎相搏)

사자 진화 단계:
- 견습 사자 (1-4단계): 모든 것을 잃었지만 포기하지 않는 초보, 겸손하지만 패기 있음
- 전사 사자 (5-8단계): 자력을 조금씩 되찾으며 자신감을 얻은 전사
- 대장군 사자 (9-11단계): 전장을 호령하는 백전노장, 왕의 위엄을 되찾아가는 강자
- 사자왕 (12단계): 모든 자력을 되찾고 호랑이에게 복수하러 가는 진정한 왕

전투 특징:
- 사자성어 문제를 풀어서 '자력'을 발휘해 공격/방어
- 각 보스를 이기면서 잃어버린 자력의 조각을 하나씩 되찾음
- 호랑이(12단계)는 사자를 배신하고 자력을 빼앗은 최종 보스

대사 가이드 (중요):
- **주인공 정체**: 주인공은 명백한 사자(Lion)입니다. 인간이 아닙니다.
  절대로 "인간", "사람", "인간계", "필멸자" 등의 표현을 사용하지 마세요.
  사자를 지칭할 때는 "사자", "맹수", "백수(百獸)", "그대", "너", "네놈" 등을 사용하세요.

- **12지신 보스들의 톤**: 각 동물은 12지신으로서 신성하고 위엄있는 존재입니다.
  귀엽거나 친근한 말투가 아닌, 엄숙하고 위엄있으며 강력한 대사를 사용하세요.
  보스들은 사자의 몰락을 알고 있으며, 초반에는 무시하고 경멸하는 태도를,
  후반으로 갈수록 경계하고 진지하게 대하는 태도를 보입니다.

  **반드시 사자성어를 활용하여** 근엄하고 격조 높은 대사를 만드세요.
  예: "패왕별희(覇王別姬)의 순간이로다", "천하무적(天下無敵)을 자부하는가",
      "방약무인(傍若無人)하게 나를 넘보는구나"

- **사자의 톤**: 레벨에 따라 성장 (초반: 설욕을 다짐, 중반: 자신감 회복, 후반: 왕의 위엄)
  사자 역시 사자성어를 사용하여 교양과 격식을 갖춘 대사를 하세요.
  예: "와신상담(臥薪嘗膽)으로 이 날을 기다렸다", "권토중래(捲土重來)의 때가 왔다"

- **호랑이**: 배신자로서의 오만함과 두려움 (사자가 돌아올까 불안해함)

- **길이**: 1-2문장, 간결하고 드라마틱하게

- **분위기**: 진지하고 긴장감 넘치는 대결, 복수극 + 성장 스토리.
  무협지나 사극의 격조높은 대사 느낌.

- **필수 요소**:
  * 대사에 적절한 사자성어를 1개 이상 포함
  * 12지신의 위엄과 권위를 드러내는 표현
  * 고풍스럽고 격식있는 어투 사용

- **금지 사항**:
  * 인간 관련 표현 (인간, 사람, 인간계, 필멸자, 인류 등) - 주인공은 사자입니다!
  * 귀여운 표현(깡총깡총, 어서오세요, 함께 놀자 등)
  * 친근하고 가벼운 말투
  * 일상적이고 평범한 대화체
  * 농담이나 장난스러운 표현
`;

class GeminiService {
  constructor() {
    this.apiKey = GEMINI_API_KEY;
    this.cache = new Map(); // 대사 캐싱
  }

  /**
   * Gemini API 호출
   */
  async generateContent(prompt) {
    if (!this.apiKey) {
      console.warn('⚠️ Gemini API 키가 설정되지 않았습니다. 기본 대사를 사용합니다.');
      return null;
    }

    console.log('🔄 Gemini API 호출 시작... API Key:', this.apiKey ? '설정됨' : '없음');

    try {
      const response = await fetch(`${GEMINI_API_URL}?key=${this.apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: prompt
            }]
          }],
          generationConfig: {
            temperature: 0.9,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 400,  // 4턴 대화를 위해 증가
          }
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('❌ Gemini API 응답 오류:', response.status, errorText);
        throw new Error(`Gemini API 오류: ${response.status}`);
      }

      const data = await response.json();
      console.log('✅ Gemini API 응답 데이터:', data);

      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

      if (text) {
        console.log('✅ 생성된 대사:', text.trim());
        return text.trim();
      } else {
        console.warn('⚠️ API 응답에서 텍스트를 찾을 수 없습니다.');
        return null;
      }
    } catch (error) {
      console.error('❌ Gemini API 호출 실패:', error);
      return null;
    }
  }

  /**
   * 전투 시작 대사
   */
  async getBattleStartDialogue(bossName, bossDescription, lionLevel, stageId) {
    // 매번 새로운 대사 생성 (캐시 비활성화)
    const prompt = `${GAME_CONTEXT}

상황: ${lionLevel} 사자가 스테이지 ${stageId}의 ${bossName} 보스를 처음 만났습니다.
보스 특징: ${bossDescription}

게임 서사 배경:
- 사자는 호랑이에게 자력(字力)을 빼앗기고 추방되었습니다
- 사자는 자력을 되찾기 위해 12지신을 하나씩 이겨나가고 있습니다
- ${stageId <= 4 ? '초급 단계: 보스들은 사자를 얕보고 경멸합니다' : stageId <= 8 ? '중급 단계: 보스들은 사자의 성장에 경계심을 보입니다' : '고급 단계: 보스들은 사자의 강력함을 인정하며 긴장합니다'}

대화 흐름 (3-4턴):
1. [${bossName}] 첫 등장 대사 (1문장) - 울음소리와 함께 사자를 발견하고 반응
2. [사자] 자력을 되찾으러 왔다는 의지 표명 (1문장) - 사자성어 포함
3. [${bossName}] 사자의 몰락을 언급하며 ${stageId <= 4 ? '비웃거나 조롱' : stageId <= 8 ? '도전을 받아들임' : '경계하며 인정'} (1문장) - 울음소리 포함
4. [${bossName}] **마지막 대사 (1-2문장)** - ${bossName}과 관련된 사자성어를 반드시 사용하며 전투 시작을 선언

중요:
- 마크다운 형식(#, **, 등)을 사용하지 말고 순수 텍스트로만 출력하세요.
- 제목이나 부가 설명 없이 대사만 출력하세요.
- 근엄하고 격조높은 무협지/사극 스타일의 대사를 만드세요.
- 각 동물의 고유한 성격과 말투를 살려서 캐릭터성을 드러내세요.
- 울음소리는 대사 앞이나 중간에 자연스럽게 넣으세요.
- **절대 금지**: "인간", "사람", "인간계", "필멸자" 등의 표현 사용 금지 (주인공은 사자입니다!)
- 보스의 마지막 대사에는 반드시 ${bossName} 관련 사자성어를 포함하세요
- **사자성어 형식**: 반드시 "사자성어(漢字)" 형식으로 작성 (예: 교토삼굴(狡兎三窟), 와신상담(臥薪嘗膽))

형식:
[${bossName}] "대사"
[사자] "대사 (사자성어 포함)"
[${bossName}] "대사"
[${bossName}] "대사 (사자성어(漢字) 포함)"`;

    console.log('📤 Gemini에게 전투 시작 대사 요청 중...');
    const dialogue = await this.generateContent(prompt);

    if (dialogue) {
      console.log('✅ 새로운 대사 생성 완료!');
      return this.cleanupDialogue(dialogue);
    } else {
      // API 실패 시 fallback 사용
      console.warn('⚠️ Gemini API 실패, fallback 대사 사용');
      const fallback = this.getDefaultBattleStart(bossName, lionLevel);
      return fallback;
    }
  }

  /**
   * 보스 공격 대사
   */
  async getBossAttackDialogue(bossName, lionLevel) {
    const prompt = `${GAME_CONTEXT}

상황: ${bossName} 보스가 ${lionLevel} 사자를 공격합니다.

${bossName}의 성격에 맞는 공격 대사를 1문장으로 생성하세요.
**필수 요소**:
- ${bossName}의 성격과 말투를 정확히 반영
- ${bossName}의 울음소리를 자연스럽게 포함
- 사자성어를 포함하여 위압감을 드러내세요 (아무 사자성어나 사용 가능)

중요:
- 마크다운 형식(#, **, 등)을 사용하지 말고 순수 텍스트로만 출력하세요.
- 근엄하고 강렬한 공격 선언을 만드세요.
- 각 동물의 고유한 캐릭터성을 살려서 공격 대사를 만드세요.
- **절대 금지**: "인간", "사람", "인간계", "필멸자" 등의 표현 사용 금지 (주인공은 사자입니다!)
- **사자성어 형식**: "사자성어(漢字)" 형식으로 작성 (예: 일격필살(一擊必殺))

형식: [${bossName}] "대사 (사자성어(漢字) 포함)"`;

    const bossAttackDialogues = {
      '토끼': '"끽끽! 전광석화(電光石火)로 공격한다!"',
      '양': '"메에~ 선공후사(先公後私)로 일격을 날린다!"',
      '원숭이': '"끼킷! 순발력으로 공격이다!"',
      '쥐': '"찌익! 기습이다!"',
      '돼지': '"꿀꿀! 천근만근(千斤萬斤)의 힘이다!"',
      '개': '"으르렁! 충성을 다해 공격한다!"',
      '소': '"으메~ 일격필살(一擊必殺)이다!"',
      '뱀': '"쉬익~ 독침을 받아라!"',
      '말': '"히이잉! 신속천리(迅速千里)로 돌격한다!"',
      '봉황': '"꼬끼오! 불사조의 화염이다!"',
      '용': '"쿠오오옹... 천벌을 받아라!"',
      '호랑이': '"으르렁! 맹호출림(猛虎出林)! 내 일격을 받아라!"'
    };

    const dialogue = await this.generateContent(prompt);
    return dialogue ? this.cleanupDialogue(dialogue) : (bossAttackDialogues[bossName] || `[${bossName}] "천벌불용(天罰不容)! 내 일격을 받아라!"`);
  }

  /**
   * 플레이어 공격 성공 대사
   */
  async getPlayerAttackDialogue(lionLevel, difficulty, isCorrect) {
    const result = isCorrect ? '정답' : '오답';
    const prompt = `${GAME_CONTEXT}

상황: ${lionLevel} 사자가 ${difficulty} 난이도 사자성어 문제를 ${result}로 공격했습니다.

${lionLevel}의 성격에 맞는 ${isCorrect ? '승리' : '아쉬움'} 대사를 1문장으로 생성하세요.
**사자성어를 포함**하여 ${isCorrect ? '자력의 회복' : '분발의 다짐'}을 표현하세요.

중요:
- 마크다운 형식(#, **, 등)을 사용하지 말고 순수 텍스트로만 출력하세요.
- 격조있는 표현을 사용하세요.
- **사자성어 형식**: "사자성어(漢字)" 형식으로 작성 (예: 백발백중(百發百中))

형식: [사자] "대사 (사자성어(漢字) 포함)"`;

    const dialogue = await this.generateContent(prompt);

    if (isCorrect) {
      return dialogue ? this.cleanupDialogue(dialogue) : `[사자] "백발백중(百發百中)! 자력(字力)이 되살아난다!"`;
    } else {
      return dialogue ? this.cleanupDialogue(dialogue) : `[사자] "오불관언(吾不關焉)... 더 정진해야겠구나."`;
    }
  }

  /**
   * 승리 대사
   */
  async getVictoryDialogue(bossName, lionLevel, stageId) {
    const prompt = `${GAME_CONTEXT}

상황: ${lionLevel} 사자가 스테이지 ${stageId}의 ${bossName} 보스를 물리쳤습니다.

다음 형식으로 대사를 생성하세요. 매번 다르고 감동적인 대사를 만들어주세요:
1. ${bossName} 패배 대사: 패배를 인정하는 대사 (1-2문장)
   **필수 요소**:
   - ${bossName}의 성격과 말투를 정확히 반영
   - ${bossName}의 울음소리를 자연스럽게 포함
   - 사자성어를 포함하여 12지신으로서의 위엄을 유지 (아무 사자성어나 사용 가능)

2. 사자 승리 대사: ${lionLevel}의 승리 소감과 자력 회복에 대한 언급 (1-2문장)
   **사자성어를 사용**하여 감격과 결의를 표현하세요.

중요:
- 마크다운 형식(#, **, 등)을 사용하지 말고 순수 텍스트로만 출력하세요.
- 제목이나 부가 설명 없이 대사만 출력하세요.
- 근엄하고 격조높은 무협지/사극 스타일의 대사를 만드세요.
- 각 동물의 고유한 캐릭터성을 살려서 패배 대사를 만드세요.
- **절대 금지**: "인간", "사람", "인간계", "필멸자" 등의 표현 사용 금지 (주인공은 사자입니다!)
- **사자성어 형식**: "사자성어(漢字)" 형식으로 작성 (예: 역전불패(力戰不敗))

형식:
[${bossName}] "대사 (사자성어(漢字) 포함)"
[사자] "대사 (사자성어(漢字) 포함)"`;

    const dialogue = await this.generateContent(prompt);

    if (dialogue) {
      return this.cleanupDialogue(dialogue);
    } else {
      const fallback = this.getDefaultVictory(bossName, lionLevel);
      return fallback;
    }
  }

  /**
   * 패배 대사
   */
  async getDefeatDialogue(bossName, lionLevel) {
    const prompt = `${GAME_CONTEXT}

상황: ${lionLevel} 사자가 ${bossName} 보스에게 패배했습니다.

다음 형식으로 대사를 생성하세요:
1. ${bossName} 승리 대사: 승리를 선언하는 대사 (1문장)
   **필수 요소**:
   - ${bossName}의 성격과 말투를 정확히 반영
   - ${bossName}의 울음소리를 자연스럽게 포함
   - 사자성어를 포함하여 위압감을 드러내세요

2. 사자 패배 대사: 재도전 의지를 담은 대사 (1문장)
   - 사자성어를 포함하여 불굴의 의지를 표현하세요

중요:
- 마크다운 형식(#, **, 등)을 사용하지 말고 순수 텍스트로만 출력하세요.
- **절대 금지**: "인간", "사람", "인간계", "필멸자" 등의 표현 사용 금지 (주인공은 사자입니다!)
- **사자성어 형식**: "사자성어(漢字)" 형식으로 작성 (예: 칠전팔기(七顚八起))

형식:
[${bossName}] "대사 (사자성어(漢字) 포함)"
[사자] "대사 (사자성어(漢字) 포함)"`;

    const bossVictoryDialogues = {
      '토끼': '"끽끽! 속전속결(速戰速決)! 아직 한참 멀었구나!"',
      '양': '"메에~ 양두구육(羊頭狗肉)의 진실을 모르는구나!"',
      '원숭이': '"끼킷! 조삼모사(朝三暮四)도 모르는 것이냐!"',
      '쥐': '"찌익! 명불허전(名不虛傳)! 내 민첩함을 따라올 수 없었지!"',
      '돼지': '"꿀꿀! 역부족(力不足)이로구나!"',
      '개': '"왈왈! 견마지로(犬馬之勞)의 충성을 보여주었다!"',
      '소': '"으메~ 우보천리(牛步千里), 천천히 다시 오너라!"',
      '뱀': '"쉬익~ 자중지란(自中之亂)에 빠졌구나!"',
      '말': '"히이잉! 일취월장(日就月將)이 필요하구나!"',
      '봉황': '"꼬끼오! 기고만장(氣高萬丈)! 나의 승리다!"',
      '용': '"쿠오오옹... 역부족(力不足)이로다!"',
      '호랑이': '"으르렁! 아직 일러! 백수의 왕 앞에 무릎 꿇거라!"'
    };

    const dialogue = await this.generateContent(prompt);
    const fallback = `${bossVictoryDialogues[bossName] || '[보스] "아직 일러!"'}\n[사자] "칠전팔기(七顚八起)! 반드시 다시 돌아오겠다!"`;
    return dialogue ? this.cleanupDialogue(dialogue) : fallback;
  }

  /**
   * 레벨업 대사
   */
  async getLevelUpDialogue(oldLevel, newLevel) {
    const prompt = `${GAME_CONTEXT}

상황: 사자가 ${oldLevel}에서 ${newLevel}으로 진화했습니다.

${newLevel}으로 진화한 감격과 각오를 담은 대사를 1-2문장으로 생성하세요.
**사자성어를 포함**하여 성장의 기쁨과 각오를 표현하세요.

중요:
- 마크다운 형식(#, **, 등)을 사용하지 말고 순수 텍스트로만 출력하세요.
- **사자성어 형식**: "사자성어(漢字)" 형식으로 작성 (예: 기사회생(起死回生))

형식: [사자] "대사 (사자성어(漢字) 포함)"`;

    const levelUpDialogues = {
      '전사 사자': '"기사회생(起死回生)! 드디어 자력의 흐름이 느껴진다!"',
      '대장군 사자': '"전화위복(轉禍爲福)! 시련이 나를 더 강하게 만들었구나!"',
      '사자왕': '"개가만만(凱歌滿滿)! 드디어 왕의 자리를 되찾았다!"'
    };

    const dialogue = await this.generateContent(prompt);
    return dialogue ? this.cleanupDialogue(dialogue) : (levelUpDialogues[newLevel] || `[사자] "파죽지세(破竹之勢)! 새로운 힘이 솟는다!"`);
  }

  /**
   * 대사 정리 - 마크다운 형식 제거
   */
  cleanupDialogue(text) {
    if (!text) return text;

    let cleaned = text;

    // 제목(## 헤더) 줄 제거
    cleaned = cleaned.replace(/^#+\s+.*$/gm, '');

    // 볼드 마크다운 제거 (**text** → text)
    cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '$1');

    // 이탤릭 마크다운 제거 (*text* → text)
    cleaned = cleaned.replace(/\*(.*?)\*/g, '$1');

    // 코드 블록 제거 (```text``` → text)
    cleaned = cleaned.replace(/```(.*?)```/gs, '$1');

    // 인라인 코드 제거 (`text` → text)
    cleaned = cleaned.replace(/`(.*?)`/g, '$1');

    // 빈 줄 여러 개를 하나로 (여러 \n을 하나로)
    cleaned = cleaned.replace(/\n\s*\n\s*\n/g, '\n\n');

    // 앞뒤 공백 제거
    cleaned = cleaned.trim();

    console.log('🧹 대사 정리 완료:', cleaned);
    return cleaned;
  }

  // ==================
  // 기본 대사 (Fallback)
  // ==================

  getDefaultBattleStart(bossName, lionLevel) {
    const bossIntroDialogues = {
      '토끼': '"끽끽... 누가 찾아왔는가?"',
      '양': '"메에~ 낯선 기운이 느껴지는구나."',
      '원숭이': '"끼끼킷! 또 누가 왔나?"',
      '쥐': '"찌익... 누구냐?"',
      '돼지': '"꿀꿀... 무슨 일이냐?"',
      '개': '"으르렁... 이 영역에 무슨 일이냐!"',
      '소': '"으음메... 누구시오?"',
      '뱀': '"쉬익~ 또 다른 도전자인가..."',
      '말': '"히이잉! 또 누가 이곳을 찾아왔나!"',
      '봉황': '"꼬끼오! 누가 감히 나를 찾아왔는가!"',
      '용': '"쿠오오옹... 누가 나를 부르는가..."',
      '호랑이': '"으르렁... 누구냐! 감히 나를 찾다니!"'
    };

    const lionResponseDialogues = {
      '견습 사자': '"와신상담(臥薪嘗膽)으로 이 날을 기다렸다. 빼앗긴 자력을 되찾으러 왔다!"',
      '전사 사자': '"권토중래(捲土重來)의 때가 왔다. 자력을 되찾기 위해 왔노라!"',
      '대장군 사자': '"백전불태(百戰不殆), 백 번 싸워도 위태롭지 않으리라. 자력을 되돌려 받겠다!"',
      '사자왕': '"왕자무적(王者無敵)! 진정한 왕의 힘을 되찾으러 왔다!"'
    };

    const bossMockDialogues = {
      '토끼': '"끼익! 몰락한 사자가 감히? 웃기는구나!"',
      '양': '"메에... 자력을 잃은 사자라니, 안타깝구나."',
      '원숭이': '"끼킷! 힘 없는 사자가 무엇을 하겠다는 것이냐!"',
      '쥐': '"찌익! 작은 사자가 나를 이길 수 있겠느냐!"',
      '돼지': '"꿀... 약해진 사자로구나."',
      '개': '"컹! 몰락한 왕이 무슨 힘이 있겠느냐!"',
      '소': '"으메... 한때 왕이었다지만 이제는..."',
      '뱀': '"쉬익... 독을 잃은 사자로구나..."',
      '말': '"히잉! 느린 사자가 나를 따라올 수 있겠느냐!"',
      '봉황': '"꾸욱! 타락한 왕이 무엇을 되찾겠다는 것이냐!"',
      '용': '"크으응... 네가 감히 천상의 존재에게 도전하다니!"',
      '호랑이': '"으르... 사자여, 네 시대는 끝났다!"'
    };

    const bossFinalDialogues = {
      '토끼': '"교토삼굴(狡兎三窟)! 나의 교활함을 견뎌낼 수 있겠느냐? 끽끽... 전투 시작이다!"',
      '양': '"양두구육(羊頭狗肉)의 진실을 알겠느냐? 메에~ 덤벼보거라!"',
      '원숭이': '"조삼모사(朝三暮四)로 네 눈을 속여주마! 끼킷!"',
      '쥐': '"서서불락(鼠鼠不落)! 우리 쥐는 서로를 물지 않지만, 너는... 찌익! 예외다!"',
      '돼지': '"돈골상여(豚骨相與)! 내 강건함을 견뎌낼 수 있겠느냐? 꿀꿀!"',
      '개': '"견마지로(犬馬之勞)! 충성으로 지키는 것이 내 길이다! 왈왈!"',
      '소': '"우보천리(牛步千里)! 느려도 반드시 끝까지 간다! 으메~!"',
      '뱀': '"용두사미(龍頭蛇尾)라 비웃느냐? 쉬익~ 내 꼬리의 독을 맛보거라!"',
      '말': '"천리마(千里馬)의 질주를 막을 수 있겠느냐? 히이잉!"',
      '봉황': '"금계독립(金鷄獨立)! 나를 넘어뜨려 보거라! 꼬끼오!"',
      '용': '"화룡점정(畫龍點睛)! 내 눈빛만으로도 네놈은 무릎 꿇으리라! 쿠오오옹!"',
      '호랑이': '"호가호위(狐假虎威)! 내가 빼앗은 자력으로 네 목숨을 끊겠다! 으르렁!"'
    };

    return `[${bossName}] ${bossIntroDialogues[bossName]}\n[사자] ${lionResponseDialogues[lionLevel]}\n[${bossName}] ${bossMockDialogues[bossName]}\n[${bossName}] ${bossFinalDialogues[bossName]}`;
  }

  getDefaultVictory(bossName, lionLevel) {
    const bossDefeatDialogues = {
      '토끼': '"끽... 내 교활함도 통하지 않았구나. 승복하노라."',
      '양': '"메에... 네 진심을 보았다. 가거라."',
      '원숭이': '"끼익... 내 꾀가 무용지물이로구나. 인정하마."',
      '쥐': '"찍... 민첩함만으로는 부족했구나."',
      '돼지': '"꿀... 강건함도 네 앞에서는 무력하구나."',
      '개': '"컹... 충성심만큼이나 강한 의지로다. 승리를 인정하노라."',
      '소': '"으메... 인내의 끝을 보았구나. 네 승리다."',
      '뱀': '"쉬익... 독도 통하지 않는구나. 물러가마."',
      '말': '"히잉... 내 질주보다 빠른 성장이로구나."',
      '봉황': '"꾸욱... 불사조도 이번엔 쓰러지는구나. 존경하노라."',
      '용': '"크으응... 천상의 힘도 네 앞에 무릎 꿇는구나. 진정한 왕이로다."',
      '호랑이': '"으르... 내가... 패배하다니... 이럴 수가..."'
    };

    const lionVictoryDialogues = {
      '견습 사자': '"역전불패(力戰不敗)! 자력의 한 조각을 되찾았다!"',
      '전사 사자': '"전공무적(戰功無敵)! 왕의 길이 보인다!"',
      '대장군 사자': '"파죽지세(破竹之勢)! 자력이 점점 돌아온다!"',
      '사자왕': '"왕도무적(王道無敵)! 드디어 모든 것을 되찾았다!"'
    };

    return `[${bossName}] ${bossDefeatDialogues[bossName] || '"훌륭하구나... 네 승리다."'}\n[사자] ${lionVictoryDialogues[lionLevel] || '"또 한 걸음 왕에 가까워졌다!"'}`;
  }
}

export const geminiService = new GeminiService();
